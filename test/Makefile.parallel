LEVEL = ../../..
include $(LEVEL)/Makefile.common

TESTDIRS = CodeGen Lexer Preprocessor Parser Sema Analysis Serialization

# Only run rewriter tests on darwin.
ifeq ($(OS),Darwin)
TESTDIRS += Rewriter
endif

TESTS = $(addsuffix .testresults, $(shell find $(TESTDIRS) \( -name '*.c' -or -name '*.cpp' -or -name '*.m' \)))

%.testresults: %
	@ printf '.'
	@ PATH=$$PATH:$(ToolDir):$(LLVM_SRC_ROOT)/test/Scripts ./TestRunner.sh $< > $@ || (echo; echo '----' $< 'failed ----')

all::
	@ echo '--- Running clang tests ---'
	@ $(MAKE) -f Makefile.parallel testclean
	@ $(MAKE) -f Makefile.parallel $(TESTS)
	@ echo
	@ $(MAKE) -f Makefile.parallel report
	@ $(MAKE) -f Makefile.parallel testclean

report: $(TESTS)
	@ cat $^

testclean:
	@ rm -f $(TESTS)

.PHONY: all report testclean
